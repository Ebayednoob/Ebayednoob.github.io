<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schism Labs - Nodal Think Tank</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        /* Custom scrollbar for a better aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #00ffff;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00cccc;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-black">
    <div id="root"></div>

    <!-- React and Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>

    <!-- Three.js and add-ons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script type="module">
        import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';
        import { DragControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/DragControls.js';
        import { PointerLockControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/PointerLockControls.js';
        window.THREE.OrbitControls = OrbitControls;
        window.THREE.DragControls = DragControls;
        window.THREE.PointerLockControls = PointerLockControls;
    </script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
            getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, serverTimestamp, orderBy
        };
    </script>

    <script type="text/babel">
        // --- App Configuration ---
        const appConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-schism-labs-app';

        // --- Helper Functions ---
        const snapToGrid = (value, gridSize = 2) => Math.round(value / gridSize) * gridSize;

        // --- Authentication Component ---
        const Login = ({ auth }) => {
            const [error, setError] = React.useState('');
            const { BrainCircuit } = lucide;

            const handleGoogleSignIn = async () => {
                setError('');
                const provider = new window.firebase.GoogleAuthProvider();
                try {
                    await window.firebase.signInWithPopup(auth, provider);
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="h-screen w-screen flex items-center justify-center bg-black text-white">
                    <div className="w-full max-w-md p-8 bg-black/80 backdrop-blur-sm rounded-2xl shadow-2xl border border-cyan-500/50 shadow-cyan-500/20">
                        <div className="flex items-center justify-center mb-6">
                            <BrainCircuit className="text-cyan-400 mr-3" size={40} />
                            <h1 className="text-3xl font-bold text-cyan-400" style={{ textShadow: '0 0 8px #0ff' }}>Schism Labs</h1>
                        </div>
                        <p className="text-center text-gray-400 mb-8">Sign in to access the think tank.</p>
                        {error && <p className="text-red-500 text-sm text-center mb-4">{error}</p>}
                        <button onClick={handleGoogleSignIn} className="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition duration-200 shadow-[0_0_15px_rgba(59,130,246,0.5)]">
                            Sign In with Google
                        </button>
                    </div>
                </div>
            );
        };

        // --- React Components ---

        const Tooltip = ({ text, children }) => {
            return (
                <div className="relative flex items-center group">
                    {children}
                    <div className="absolute left-full ml-2 w-48 p-2 bg-gray-900 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-50 border border-cyan-500/30">
                        {text}
                    </div>
                </div>
            );
        };

        // Draggable Window Hook
        const useDraggable = () => {
            const [position, setPosition] = React.useState({ x: 100, y: 100 });
            const isDragging = React.useRef(false);
            const offset = React.useRef({ x: 0, y: 0 });

            const handleMouseDown = (e) => {
                isDragging.current = true;
                offset.current = {
                    x: e.clientX - position.x,
                    y: e.clientY - position.y,
                };
            };

            const handleMouseMove = React.useCallback((e) => {
                if (!isDragging.current) return;
                setPosition({
                    x: e.clientX - offset.current.x,
                    y: e.clientY - offset.current.y,
                });
            }, []);

            const handleMouseUp = React.useCallback(() => {
                isDragging.current = false;
            }, []);

            React.useEffect(() => {
                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseup', handleMouseUp);
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [handleMouseMove, handleMouseUp]);

            return { position, handleMouseDown };
        };


        // Draggable and Collapsible Packet Editor Window
        const PacketEditorWindow = ({ node, onClose, team, onUpdateNode }) => {
            const [isCollapsed, setIsCollapsed] = React.useState(false);
            const { position, handleMouseDown } = useDraggable();
            const previewRef = React.useRef(null);
            const { ChevronsRightLeft, Minus, X } = lucide;

            const geometries = React.useMemo(() => ({
                sphere: new THREE.SphereGeometry(1, 16, 16),
                box: new THREE.BoxGeometry(1.5, 1.5, 1.5),
                cone: new THREE.ConeGeometry(1, 2, 16),
                pyramid: new THREE.CylinderGeometry(0, 1.5, 2, 4),
                torus: new THREE.TorusGeometry(1, 0.4, 16, 32),
                dodecahedron: new THREE.DodecahedronGeometry(1.5),
            }), []);

            React.useEffect(() => {
                if (!node || !previewRef.current) return;

                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                camera.position.z = 5;

                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(128, 128);
                previewRef.current.innerHTML = '';
                previewRef.current.appendChild(renderer.domElement);

                const material = new THREE.MeshBasicMaterial({ color: node.color || '#00ffff', wireframe: true });
                const geometry = geometries[node.formId] || geometries.sphere;
                const mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);

                const animate = () => {
                    if (!mount) return;
                    requestAnimationFrame(animate);
                    mesh.rotation.y += 0.01;
                    renderer.render(scene, camera);
                };
                
                let mount = true;
                animate();

                return () => {
                    mount = false;
                };
            }, [node, geometries]);
            
            if (!node) return null;

            return (
                <div
                    className="absolute bg-black/70 backdrop-blur-md border border-cyan-500/30 rounded-lg text-white shadow-[0_0_25px_rgba(0,255,255,0.3)] z-30"
                    style={{ left: `${position.x}px`, top: `${position.y}px`, width: '500px' }}
                >
                    <div
                        className="flex justify-between items-center p-2 bg-black/50 cursor-move"
                        onMouseDown={handleMouseDown}
                    >
                        <h1 className="text-lg font-bold text-cyan-400">{node.label}</h1>
                        <div className="flex items-center">
                            <button onClick={() => setIsCollapsed(!isCollapsed)} className="p-1 hover:bg-gray-700 rounded">
                                {isCollapsed ? <ChevronsRightLeft size={16} /> : <Minus size={16} />}
                            </button>
                            <button onClick={onClose} className="p-1 hover:bg-red-700 rounded ml-2">
                                <X size={16} />
                            </button>
                        </div>
                    </div>
                    {!isCollapsed && (
                        <div className="p-4 flex space-x-4">
                            <div className="w-1/3 flex flex-col items-center">
                                <div ref={previewRef} className="w-32 h-32 mb-4"></div>
                                <input type="color" value={node.color || '#00ffff'} onChange={(e) => onUpdateNode(node.id, { color: e.target.value })} className="w-full h-8 p-0 border-none cursor-pointer bg-transparent" />
                            </div>
                            <div className="w-2/3 space-y-3">
                                <input type="text" value={node.label} onChange={(e) => onUpdateNode(node.id, { label: e.target.value })} placeholder="Packet Label" className="w-full bg-gray-800 text-white p-2 rounded-md ring-1 ring-cyan-500/30 focus:ring-cyan-500" />
                                <select value={node.type} onChange={(e) => onUpdateNode(node.id, { type: e.target.value })} className="w-full bg-gray-800 text-white p-2 rounded-md ring-1 ring-cyan-500/30 focus:ring-cyan-500">
                                    <option value="idea">Idea</option><option value="task">Task</option><option value="question">Question</option>
                                </select>
                                <select value={node.assignedTo || ''} onChange={(e) => onUpdateNode(node.id, { assignedTo: e.target.value || null })} className="w-full bg-gray-800 text-white p-2 rounded-md ring-1 ring-cyan-500/30 focus:ring-cyan-500">
                                    <option value="">Unassigned</option>
                                    {team.map(member => <option key={member.id} value={member.id}>{member.name}</option>)}
                                </select>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Terminal Window Component
        const TerminalWindow = ({ onClose }) => {
            const [isCollapsed, setIsCollapsed] = React.useState(false);
            const { position, handleMouseDown } = useDraggable();
            const [history, setHistory] = React.useState([]);
            const [input, setInput] = React.useState('');
            const { ChevronsRightLeft, Minus, X } = lucide;

            const handleCommand = (e) => {
                e.preventDefault();
                setHistory(prev => [...prev, `> ${input}`]);
                if (input.toLowerCase() === 'clear') {
                    setHistory([]);
                } else {
                    setHistory(prev => [...prev, `Unrecognized command: ${input}`]);
                }
                setInput('');
            };

            return (
                <div
                    className="absolute bg-black/80 backdrop-blur-md border border-fuchsia-500/30 rounded-lg text-white shadow-[0_0_25px_rgba(217,70,239,0.3)] z-30 font-mono"
                    style={{ left: `${position.x}px`, top: `${position.y}px`, width: '600px', height: '400px' }}
                >
                    <div className="flex justify-between items-center p-2 bg-black/50 cursor-move" onMouseDown={handleMouseDown}>
                        <h1 className="text-lg font-bold text-fuchsia-400">PCL Terminal</h1>
                        <div className="flex items-center">
                            <button onClick={() => setIsCollapsed(!isCollapsed)} className="p-1 hover:bg-gray-700 rounded">{isCollapsed ? <ChevronsRightLeft size={16} /> : <Minus size={16} />}</button>
                            <button onClick={onClose} className="p-1 hover:bg-red-700 rounded ml-2"><X size={16} /></button>
                        </div>
                    </div>
                    {!isCollapsed && (
                        <div className="p-4 h-[calc(100%-40px)] flex flex-col">
                            <div className="flex-grow overflow-y-auto text-sm">
                                <p className="text-fuchsia-400">Packet Command Language (PCL) v1.0</p>
                                <p className="text-gray-400">Type 'help' for a list of commands.</p>
                                {history.map((line, i) => <p key={i}>{line}</p>)}
                            </div>
                            <form onSubmit={handleCommand} className="flex items-center mt-2">
                                <span className="text-cyan-400 mr-2">&gt;</span>
                                <input 
                                    type="text" 
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    className="w-full bg-transparent focus:outline-none"
                                    autoFocus
                                />
                            </form>
                        </div>
                    )}
                </div>
            );
        };


        // Main Toolbar Component
        const MainToolbar = ({ onToggleControlPanel, onToggleChat, onToggleTerminal, onToggleFPSMode }) => {
            const { PanelLeft, MessageSquare, Terminal, Gamepad2 } = lucide;
            return (
                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/70 backdrop-blur-md border border-cyan-500/30 rounded-lg text-white shadow-[0_0_25px_rgba(0,255,255,0.3)] z-40">
                    <div className="flex items-center p-2 space-x-2">
                        <button onClick={onToggleControlPanel} className="p-2 hover:bg-cyan-500/20 rounded flex items-center"><PanelLeft size={18} className="mr-2"/> Panel</button>
                        <button onClick={onToggleChat} className="p-2 hover:bg-cyan-500/20 rounded flex items-center"><MessageSquare size={18} className="mr-2"/> Chat</button>
                        <button onClick={onToggleTerminal} className="p-2 hover:bg-cyan-500/20 rounded flex items-center"><Terminal size={18} className="mr-2"/> Terminal</button>
                        <button onClick={onToggleFPSMode} className="p-2 hover:bg-cyan-500/20 rounded flex items-center"><Gamepad2 size={18} className="mr-2"/> FPS Mode</button>
                    </div>
                </div>
            );
        };


        // Sidebar Control Panel component
        const ControlPanel = ({ userId, team, nodes, selectedNodeId, onSetUserName, onAddNode, onSelectNode, onUpdateNode, onDeleteNode, onLinkNodes, onJoinNode, linkingState, setLinkType, setLinkFrequency, onSignOut }) => {
            const [userName, setUserName] = React.useState('');
            const [nodeLabel, setNodeLabel] = React.useState('');
            const currentUser = team.find(m => m.id === userId);
            const selectedNode = nodes.find(n => n.id === selectedNodeId);
            const { BrainCircuit, Plus, Eye, Link, Trash2, HelpCircle, Palette, Ruler, UserPlus, LogOut } = lucide;

            React.useEffect(() => {
                if (selectedNode) setNodeLabel(selectedNode.label);
                else setNodeLabel('');
            }, [selectedNode]);
            
            React.useEffect(() => {
                if (currentUser) setUserName(currentUser.name);
                else setUserName('');
            }, [currentUser]);

            const handleSetUserName = (e) => {
                e.preventDefault();
                if (userName.trim()) onSetUserName(userName.trim());
            };

            const handleUpdateLabel = (e) => {
                setNodeLabel(e.target.value);
                if (selectedNode) onUpdateNode(selectedNode.id, { label: e.target.value });
            };

            return (
                <div className="w-80 bg-black/70 backdrop-blur-md text-white p-4 flex flex-col h-full overflow-y-auto z-10 border-r border-cyan-500/30">
                    <div className="flex items-center mb-6">
                        <BrainCircuit className="text-cyan-400 mr-3" size={32} />
                        <h1 className="text-2xl font-bold text-cyan-400" style={{ textShadow: '0 0 5px #0ff' }}>Schism Labs</h1>
                    </div>
                    <div className="mb-4 p-2 bg-gray-900/70 rounded-lg border border-cyan-500/20">
                        <p className="text-xs text-cyan-300 mb-1">Your User ID</p>
                        <p className="text-sm font-mono break-all">{userId}</p>
                    </div>

                    <div className="mb-6">
                        <h2 className="text-lg font-semibold mb-3 text-cyan-400">Controls</h2>
                        <button onClick={() => onAddNode('New Packet')} className="w-full flex items-center justify-center bg-cyan-500 hover:bg-cyan-600 text-black font-bold py-2 px-4 rounded-lg transition duration-200 shadow-[0_0_10px_rgba(0,255,255,0.4)]">
                            <Plus className="mr-2" size={20} /> Add Packet
                        </button>
                    </div>
                    
                    {selectedNode && (
                        <div className="mb-6 p-3 bg-gray-900/70 rounded-lg border border-cyan-500/20">
                            <h3 className="text-md font-semibold mb-3 text-cyan-400">Edit Selected Packet</h3>
                            <button onClick={() => onJoinNode(selectedNode.id)} className="w-full mb-3 flex items-center justify-center bg-green-500 hover:bg-green-600 text-black font-bold py-2 px-4 rounded-lg transition duration-200 shadow-[0_0_10px_rgba(34,197,94,0.4)]">
                                <Eye className="mr-2" size={20} /> View Packet
                            </button>
                            <input type="text" value={nodeLabel} onChange={handleUpdateLabel} placeholder="Packet Label" className="w-full bg-gray-800 text-white p-2 rounded-md mb-3 ring-1 ring-cyan-500/30 focus:ring-cyan-500" />
                            <select value={selectedNode.type} onChange={(e) => onUpdateNode(selectedNode.id, { type: e.target.value })} className="w-full bg-gray-800 text-white p-2 rounded-md mb-3 ring-1 ring-cyan-500/30 focus:ring-cyan-500">
                                <option value="idea">Idea</option><option value="task">Task</option><option value="question">Question</option>
                            </select>
                            <div className="flex items-center my-3">
                                <select value={selectedNode.formId || 'sphere'} onChange={(e) => onUpdateNode(selectedNode.id, { formId: e.target.value })} className="w-full bg-gray-800 text-white p-2 rounded-md ring-1 ring-cyan-500/30 focus:ring-cyan-500">
                                    <option value="sphere">Sphere</option>
                                    <option value="pyramid">Pyramid</option>
                                    <option value="box">Cube</option>
                                    <option value="cone">Cone</option>
                                    <option value="torus">Torus</option>
                                    <option value="dodecahedron">Dodecahedron</option>
                                </select>
                                <Tooltip text="Defines the base geometric structure of the packet.">
                                    <HelpCircle className="ml-2 text-cyan-400 cursor-help" size={20} />
                                </Tooltip>
                            </div>
                            <select value={selectedNode.assignedTo || ''} onChange={(e) => onUpdateNode(selectedNode.id, { assignedTo: e.target.value || null })} className="w-full bg-gray-800 text-white p-2 rounded-md mb-3 ring-1 ring-cyan-500/30 focus:ring-cyan-500">
                                <option value="">Unassigned</option>
                                {team.map(member => <option key={member.id} value={member.id}>{member.name}</option>)}
                            </select>
                            <div className="space-y-3 mt-3">
                                <div className="flex items-center">
                                    <Palette className="mr-3 text-cyan-400" size={20} />
                                    <input type="color" value={selectedNode.color || '#00ffff'} onChange={(e) => onUpdateNode(selectedNode.id, { color: e.target.value })} className="w-full h-8 p-0 border-none cursor-pointer bg-transparent" />
                                </div>
                                <div className="flex items-center">
                                    <Ruler className="mr-3 text-cyan-400" size={20} />
                                    <input type="range" min="1" max="5" step="0.1" value={selectedNode.size || 2} onChange={(e) => onUpdateNode(selectedNode.id, { size: parseFloat(e.target.value) })} className="w-full" />
                                </div>
                            </div>
                            <div className="mt-4">
                                <button onClick={onLinkNodes} className="w-full flex items-center justify-center bg-fuchsia-500 hover:bg-fuchsia-600 text-black font-bold py-2 px-4 rounded-lg transition duration-200 shadow-[0_0_10px_rgba(217,70,239,0.4)]">
                                    <Link className="mr-2" size={20} /> Link Packets
                                </button>
                                {linkingState && (
                                    <div className="mt-2 space-y-2">
                                        <select onChange={(e) => setLinkType(e.target.value)} className="w-full bg-gray-800 text-white p-2 rounded-md ring-1 ring-fuchsia-500/30 focus:ring-fuchsia-500">
                                            <option value="RELATES_TO">Relates To</option>
                                            <option value="DEPENDS_ON">Depends On</option>
                                            <option value="LEADS_TO">Leads To</option>
                                            <option value="ANSWERS">Answers</option>
                                        </select>
                                        <select onChange={(e) => setLinkFrequency(e.target.value)} className="w-full bg-gray-800 text-white p-2 rounded-md ring-1 ring-fuchsia-500/30 focus:ring-fuchsia-500">
                                            <option value="alpha">Alpha Channel</option>
                                            <option value="beta">Beta Channel</option>
                                            <option value="gamma">Gamma Channel</option>
                                        </select>
                                    </div>
                                )}
                            </div>
                            <button onClick={onDeleteNode} className="w-full mt-4 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-[0_0_10px_rgba(220,38,38,0.4)]">
                                <Trash2 className="mr-2" size={20} /> Delete Packet
                            </button>
                        </div>
                    )}
                    
                    <div className="mb-6">
                        <h2 className="text-lg font-semibold mb-3 text-cyan-400">Idea Explorer</h2>
                        <ul className="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-900/70 rounded-lg border border-cyan-500/20">
                            {nodes.map(node => (
                                <li key={node.id} 
                                    onClick={() => onSelectNode(node.id)}
                                    className={`p-2 rounded-md cursor-pointer transition-colors ${selectedNodeId === node.id ? 'bg-cyan-500 text-black' : 'bg-gray-800 hover:bg-gray-700'}`}>
                                    {node.label}
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="flex-grow">
                        <h2 className="text-lg font-semibold mb-3 flex items-center text-cyan-400"><Users className="mr-2" />Team</h2>
                        <form onSubmit={handleSetUserName} className="flex mb-3">
                            <input type="text" value={userName} onChange={(e) => setUserName(e.target.value)} placeholder="Set your display name" className="flex-grow bg-gray-800 text-white p-2 rounded-l-md ring-1 ring-cyan-500/30 focus:ring-cyan-500" />
                            <button type="submit" className="bg-cyan-500 hover:bg-cyan-600 p-2 rounded-r-md"><UserPlus size={20} color="black"/></button>
                        </form>
                        <ul className="space-y-2">{team.map(member => (<li key={member.id} className="flex items-center p-2 bg-gray-900/70 rounded-md"><span className="w-4 h-4 rounded-full mr-3" style={{ backgroundColor: member.color, boxShadow: `0 0 8px ${member.color}` }}></span><span>{member.name}</span></li>))}</ul>
                    </div>
                    <button onClick={onSignOut} className="w-full mt-4 flex items-center justify-center bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        <LogOut className="mr-2" size={20} /> Sign Out
                    </button>
                </div>
            );
        };

        // Chat Panel component
        const ChatPanel = ({ messages, team, onSendMessage }) => {
            const [newMessage, setNewMessage] = React.useState('');
            const messagesEndRef = React.useRef(null);
            const { Send } = lucide;

            React.useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const handleSendMessage = (e) => {
                e.preventDefault();
                if (newMessage.trim()) { onSendMessage(newMessage.trim()); setNewMessage(''); }
            };

            const getSender = (senderId) => team.find(m => m.id === senderId) || { name: 'Guest', color: '#ccc' };

            return (
                <div className="w-96 bg-black/70 backdrop-blur-md text-white p-4 flex flex-col h-full border-l border-cyan-500/30">
                    <h2 className="text-xl font-semibold mb-4 text-cyan-400" style={{ textShadow: '0 0 5px #0ff' }}>Team Chat</h2>
                    <div className="flex-grow overflow-y-auto mb-4 pr-2">
                        {messages.map(msg => {
                            const sender = getSender(msg.senderId);
                            return (
                                <div key={msg.id} className="mb-3">
                                    <div className="flex items-center mb-1">
                                        <span className="w-3 h-3 rounded-full mr-2" style={{ backgroundColor: sender.color, boxShadow: `0 0 6px ${sender.color}` }}></span>
                                        <span className="font-bold text-sm" style={{ color: sender.color }}>{sender.name}</span>
                                        <span className="text-xs text-gray-500 ml-2">{new Date(msg.timestamp).toLocaleTimeString()}</span>
                                    </div>
                                    <p className="text-gray-200 ml-5 break-words">{msg.text}
